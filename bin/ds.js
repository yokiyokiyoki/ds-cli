#!/usr/bin/env node
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(require("child_process"),require("rimraf"),require("inquirer"),require("axios")):"function"==typeof define&&define.amd?define(["child_process","rimraf","inquirer","axios"],r):r((e=e||self).child_process,e.rm$1,e.inquirer$2,e.axios)}(this,function(r,n,o,i){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n,o=o&&o.hasOwnProperty("default")?o.default:o,i=i&&i.hasOwnProperty("default")?i.default:i;var t=require("path"),c=function(e){return/^[./]|(^[a-zA-Z]:)/.test(e)},u=function(e){return t.isAbsolute(e)?e:t.normalize(t.join(process.cwd(),e))},a=require("chalk"),s=require("util").format,l=require("log-symbols"),f="ds-cli",p=a.gray("······");var m={log:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t=s.apply(s,e);console.log(l.info,a.white(f),p,t)},fatal:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];e[0]instanceof Error&&(e[0]=e[0].message.trim());var t=s.apply(s,e);console.error(l.error,a.red(f),p,t),process.exit(1)},success:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t=s.apply(s,e);console.log(l.success,a.green(f),p,t)}};function d(i,a,s,c){return new(s||(s=Promise))(function(e,r){function t(e){try{o(c.next(e))}catch(e){r(e)}}function n(e){try{o(c.throw(e))}catch(e){r(e)}}function o(r){r.done?e(r.value):new s(function(e){e(r.value)}).then(t,n)}o((c=c.apply(i,a||[])).next())})}function h(t,n){var o,i,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&r[0]?i.return:r[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,r[1])).done)return a;switch(i=0,a&&(r=[2&r[0],a.value]),r[0]){case 0:case 1:a=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){s.label=r[1];break}if(6===r[0]&&s.label<a[1]){s.label=a[1],a=r;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(r);break}a[2]&&s.ops.pop(),s.trys.pop();continue}r=n.call(t,s)}catch(e){r=[6,e],i=0}finally{o=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}}var g=new(function(){function e(){}return e.prototype.remove=function(e){return new Promise(function(r,t){n(e,function(e){e?t({type:"remove",msg:e}):r()})})},e.prototype.shell=function(e){return new Promise(function(n,o){r.exec(e,function(e,r,t){e?o({type:"shell",msg:r+t}):n(r)})})},e.prototype.ask=function(t){return new Promise(function(r,e){o.prompt(t).then(function(e){r(e)})})},e.prototype.request=function(e){return new Promise(function(r,t){i(e).then(function(e){r(e)}).catch(function(e){t({type:"ajax请求",msg:e})})})},e}()),y=require("semver"),v=require("../package.json"),q=require("chalk"),b=require("log-symbols"),w=require("child_process").execSync,k=function(){var e="",r="";try{e=w("git config --get user.name"),r=w("git config --get user.email")}catch(e){console.log(e)}return((e=e&&JSON.stringify(e.toString().trim()).slice(1,-1))||"")+((r=r&&" <"+r.toString().trim()+">")||"")},j=require("path"),x=require("read-metadata"),S=require("fs").existsSync,O=require("validate-npm-package-name");function P(e,r){var t,n,o=function(e){var r=j.join(e,"meta.json"),t=j.join(e,"meta.js"),n={};if(S(r))n=x.sync(r);else if(S(t)){var o=require(j.resolve(t));if(o!==Object(o))throw new Error("meta.js 需要导出一个对象");n=o}return n}(r);E(o,"name",e),t=o.prompts.name,n=t.validate,t.validate=function(e){var r=O(e);if(r.validForNewPackages)return"function"!=typeof n||n(e);var t=(r.errors||[]).concat(r.warnings||[]);return"Sorry, "+t.join(" and ")+"."};var i=k();return i&&E(o,"author",i),o}function E(e,r,t){e.schema&&(e.prompts=e.schema,delete e.schema);var n=e.prompts||(e.prompts={});n[r]&&"object"==typeof n[r]?n[r].default=t:n[r]={type:"string",default:t}}var _=require("async"),A=require("inquirer"),G={string:"input",boolean:"confirm"};function H(t,n,e){_.eachSeries(Object.keys(t),function(e,r){!function(r,t,e,n){var o=e.default;"function"==typeof e.default&&(o=function(){return e.default.bind(this)(r)});A.prompt([{type:G[e.type]||e.type,name:t,message:e.message||e.label||t,default:o,choices:e.choices||[],validate:e.validate||function(){return!0}}]).then(function(e){Array.isArray(e[t])?(r[t]={},e[t].forEach(function(e){r[t][e]=!0})):"string"==typeof e[t]?r[t]=e[t].replace(/"/g,'\\"'):r[t]=e[t],n()}).catch(n)}(n,e,t[e],r)},e)}var N=require("chalk"),T=require("log-symbols");var z=require("minimatch"),F=function(t,n,o,e){if(!n)return e();var i=Object.keys(t);Object.keys(n).forEach(function(r){i.forEach(function(e){z(e,r,{dot:!0})&&(function(r,e){var t=new Function("data","with (data) { return "+r+"}");try{return t(e)}catch(e){console.error(T.error,N.red("执行meta的filter字段时候的错误"+r))}}(n[r],o)||delete t[e])})}),e()},$=require("chalk"),B=require("metalsmith"),D=require("handlebars"),J=require("async"),M=require("consolidate").handlebars.render,Z=require("path");function C(s,c,u,l){return d(this,void 0,void 0,function(){var i,r,a,t;return h(this,function(e){var n,o;return i=P(s,c),r=B(Z.join(c,"template")),a=Object.assign(r.metadata(),{destDirName:s,inPlace:u===process.cwd()}),i.helpers&&Object.keys(i.helpers).map(function(e){D.registerHelper(e,i.helpers[e])}),t={chalk:$,logger:m},i.metalsmith&&"function"==typeof i.metalsmith.before&&i.metalsmith.before(r,i,t),r.use((o=i.prompts,function(e,r,t){H(o,r.metadata(),t)})).use((n=i.filters,function(e,r,t){F(e,n,r.metadata(),t)})).use(function(o,e,r){var t=Object.keys(o),i=e.metadata();J.each(t,function(t,n){var e=o[t].contents.toString();if(!/{{([^{}]+)}}/g.test(e))return n();M(e,i,function(e,r){if(e)return e.message="["+t+"] "+e.message,n(e);o[t].contents=new Buffer(r),n()})},r)}),"function"==typeof i.metalsmith?i.metalsmith(r,i,t):i.metalsmith&&"function"==typeof i.metalsmith.after&&i.metalsmith.after(r,i,t),r.clean(!1).source(".").destination(u).build(function(e,r){if(l(e),"function"==typeof i.complete){var t={chalk:$,logger:m,files:r};i.complete(a,t)}else!function(e,r){if(!e)return;M(e,r,function(e,r){e?console.error("\n模板渲染完成的时候出错 "+e.message.trim()):console.log("\n"+r.split(/\r?\n/g).map(function(e){return"   "+e}).join("\n"))})}(i.completeMessage,a)}),[2,a]})})}D.registerHelper("if_eq",function(e,r,t){return e===r?t.fn(this):t.inverse(this)}),D.registerHelper("unless_eq",function(e,r,t){return e===r?t.inverse(this):t.fn(this)});var I=require("download-git-repo"),K=require("fs").existsSync,L=require("ora"),Q=require("rimraf").sync,R=require("path"),U=require("user-home");require("log-symbols");require("commander");var V=require("fs").existsSync,W=require("inquirer"),X=require("path");var Y=require("log-symbols"),ee=require("chalk");var e=require("commander"),re=require("../package.json"),te={init:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t=e[0],n=e[1],i=X.resolve(n||"."),o=!n||"."===n,a=o?X.relative("../",process.cwd()):n;function s(){if(c(t)){var e=u(t);X.exists(e)?C(a,e,i,function(e){e&&m.fatal(e),m.success("生成"+a+"文件夹")}):m.fatal("本地模板"+t+"没有找到")}else o=function(){!function(e,r,t,n){var o=L("正在努力下载模板ing...");o.start();var i=R.join(U,".ds-templates",r.replace(/[\/:]/g,"-"));K(i)&&Q(i),I(e,i,{clone:!0},function(e){o.stop(),e&&m.fatal("拉取远程仓库失败 "+r+": "+e.message.trim()),C(n,i,t,function(e){e&&m.fatal(e),m.success("生成"+n+"文件夹")})})}("direct:https://github.com/yokiyokiyoki/ds-cli-"+t+"-template#master",t,i,a)},d(void 0,void 0,void 0,function(){var r,t,n;return h(this,function(e){switch(e.label){case 0:return y.satisfies(process.version,v.engines.node)?[4,g.request({url:"https://registry.npmjs.org/@datastory/ds-cli",method:"GET"})]:[2,console.log(b.error,q.red(" 你的node版本必须 >="+v.engines.node+".x 才能使用ds-cli"))];case 1:return 200===(r=e.sent()).status?(t=r.data["dist-tags"].latest,n=v.version,y.lt(n,t)&&(console.log(b.info,q.yellow("报告!有一个新的ds-cli版本")),console.log(b.success,"现在最新的是:"+q.green(t)),console.log(b.warning,"你下载的是:"+q.red(n)))):console.log(b.error,"获取线上仓库失败"+r.data),o(),[2]}})});var o}o||V(i)?W.prompt([{type:"confirm",message:o?"在当前目录生成模板":"目录已存在，是否继续？",name:"ok"}]).then(function(e){e.ok&&s()}).catch(m.fatal):s()},list:function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return d(this,void 0,void 0,function(){var r;return h(this,function(e){switch(e.label){case 0:return[4,g.request({url:"https://api.github.com/users/yokiyokiyoki/repos",method:"GET"})];case 1:return 200===(r=e.sent()).status?(console.log(Y.info,ee.green("共有下列模板")),r.data.filter(function(e){return e.name.includes("ds-cli")&&e.name.includes("template")}).forEach(function(e){console.log(),console.log(ee.green(e.name))})):console.log(Y.error,"获取仓库列表失败"+r.data),[2]}})})}};function ne(e){for(var r=[],t=1;t<arguments.length;t++)r[t-1]=arguments[t];re.debug=r[0].debug,te[e].apply(te,r)}e.usage("<command>").version(re.version).description("欢迎使用ds-cli"),e.command("init").description("初始化组件模板").action(function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return ne.apply(void 0,["init"].concat(e))}),e.command("list").description("查看线上组件模板").action(function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return ne.apply(void 0,["list"].concat(e))}),e.command("help").description("查看帮助").action(function(){return e.help()}),e.parse(process.argv),e.args.length||e.help()});
